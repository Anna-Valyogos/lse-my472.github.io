# Using BigQuery

## Data

We will use the NYC Bicycle Hire data we looked at in lecture. The database contains all Citi Bike trips (NYC's bike-sharing service) since Citi Bike launched in September 2013.

```{r}
library("DBI")
library("bigrquery")
```

## Queries

1. First, connect to the database and see the first 5 entries.

```{r}
db <- dbConnect(
  bigrquery::bigquery(),
  project = "bigquery-public-data",
  dataset = "new_york",
  billing = "my472-week-10-lecture"
)

dbGetQuery(db, "SELECT * FROM citibike_trips LIMIT 5")

```

2. What is the average trip duration based on the age of the riders?

```{r}
dbGetQuery(db, "SELECT birth_year, AVG( TIMESTAMP_DIFF(stoptime, starttime, MINUTE) )
          AS duration_minutes
          FROM citibike_trips
          GROUP BY birth_year
          ORDER BY birth_year")

dbGetQuery(db, "SELECT (EXTRACT(YEAR FROM CURRENT_TIMESTAMP) - birth_year) AS age,
          AVG( TIMESTAMP_DIFF(stoptime, starttime, MINUTE) )
          AS duration_minutes
          FROM citibike_trips
          GROUP BY age
          ORDER BY age DESC")
```

3. What is the average distance of a CitiBike trip based on the age of the riders?

```{r}
dbGetQuery(db, "SELECT (EXTRACT(YEAR FROM CURRENT_TIMESTAMP) - birth_year) AS age,
           AVG( (ABS(start_station_latitude - end_station_latitude)
           + ABS(start_station_longitude - end_station_longitude)) * 111) AS average_distance,
           FROM citibike_trips
           GROUP BY age")
```

4. What is the average speed of a CitiBike trip?

```{r}
dbGetQuery(db,
           "SELECT AVG( (ABS(start_station_latitude - end_station_latitude)
           + ABS(start_station_longitude - end_station_longitude)) * 111 / tripduration )
           AS average_speed
           FROM citibike_trips")

```

5. What is the average speed based on age?

```{r}
dbGetQuery(db,
           "SELECT (EXTRACT(YEAR FROM CURRENT_TIMESTAMP) - birth_year) AS age,
           AVG( (ABS(start_station_latitude - end_station_latitude)
           + ABS(start_station_longitude - end_station_longitude)) * 111 / tripduration )
           AS average_speed
           FROM citibike_trips,
           GROUP BY age")


```
